---

copyright:
  years: 2018, 2019
lastupdated: "2019-05-17"

keywords: create, configure, permissions, ACL, virtual, server, instance, subnet, block, storage, volume, security, group, images, Windows, Linux, example, monitoring, VPN, load balancer, IKE, IPsec

subcollection: vpc-on-classic

---

{:shortdesc: .shortdesc}
{:new_window: target="_blank"}
{:codeblock: .codeblock}
{:pre: .pre}
{:screen: .screen}
{:tip: .tip}
{:important: .important}
{:download: .download}
{:DomainName: data-hd-keyref="DomainName"}

# 使用 {{site.data.keyword.cloud_notm}} 控制台创建 VPC
{: #creating-a-vpc-using-the-ibm-cloud-console}
[comment]: # (链接的帮助主题)

本文档说明了如何使用 {{site.data.keyword.cloud_notm}} 控制台来创建和配置 {{site.data.keyword.cloud}} Virtual Private Cloud。

要创建和配置虚拟私有云 (VPC) 和其他附加资源，请按以下顺序执行后续各部分中的步骤：

1. 创建 VPC 和子网以定义网络。创建子网时，连接公共网关，以允许子网中的所有资源与公用因特网进行通信。
1. 配置访问控制表 (ACL) 以限制子网的入站和出站流量。缺省情况下，将允许所有流量。
1. 创建虚拟服务器实例。
1. 创建块存储卷并将其连接到实例。
1. 配置安全组，以定义针对实例允许的入站和出站流量。
1. 保留并关联浮动 IP 地址，以支持实例可从因特网进行访问。
1. 创建负载均衡器，以在多个实例上分配请求。
1. 创建虚拟专用网 (VPN)，以便 VPC 可以安全地连接到其他专用网络，例如内部部署网络或其他 VPC。

## 开始之前
{: #before}
确保您具有足够的许可权来创建和管理 VPC 中的资源。有关更多信息，请参阅[管理针对 VPC 资源的用户许可权](/docs/vpc-on-classic?topic=vpc-on-classic-managing-user-permissions-for-vpc-resources)。

生成 SSH 密钥，该密钥将用于连接到虚拟服务器实例。例如，在 Linux 服务器上，通过运行命令 `ssh-keygen -t rsa -C "user_ID"` 来生成 SSH 密钥。该命令会生成两个文件。生成的公用密钥位于 `<your key>.pub` 文件中。

如果计划创建负载均衡器并将 HTTPS 用于侦听器，那么需要 SSL 证书。您可以使用 [IBM 证书管理器 ![外部链接图标](../../icons/launch-glyph.svg "外部链接图标")](https://{DomainName}/catalog/services/certificate-manager){: new_window} 来管理证书。此外，还必须创建授权，以允许负载均衡器实例访问包含 SSL 证书的证书管理器实例。可以通过[身份和访问权授权 ![ 外部链接图标](../../icons/launch-glyph.svg "外部链接图标")](https://{DomainName}/iam/#/authorizations){: new_window} 来创建授权。对于源，选择 **VPC 基础架构**作为“源服务”，选择 **Load Balancer for VPC** 作为“资源类型”，对于“源资源实例”，选择**所有资源实例**。选择**证书管理器**作为“目标服务”，并为服务访问角色分配**写入者**。将“目标服务实例”设置为**所有实例**，或设置为您的特定证书管理器实例。有关更多信息，请参阅[在 IBM Cloud VPC 中使用负载均衡器](/docs/vpc-on-classic-network?topic=vpc-on-classic-network---using-load-balancers-in-ibm-cloud-vpc)。

## 创建 VPC 和子网

要创建 VPC 和子网，请执行以下操作：

1. 打开 [{{site.data.keyword.cloud_notm}} 控制台 ![外部链接图标](../../icons/launch-glyph.svg "外部链接图标")](https://{DomainName}){: new_window}。
1. 单击**“菜单”图标 ![“菜单”图标](../../icons/icon_hamburger.svg) > VPC 基础架构 > 网络 > VPC**，然后单击**新建虚拟私有云**。
1. 为 VPC 输入名称，例如 `my-vpc`。
1. 为 VPC 及其所有连接的资源选择资源组。资源组支持对帐户资源进行组织，以进行访问控制和计费。有关更多信息，请参阅[在资源组中组织资源的最佳实践](/docs/resources?topic=resources-bp_resourcegroups)。
1. _可选：_输入标记以帮助您组织和查找资源。以后可以添加更多标记。有关更多信息，请参阅[使用标记](/docs/resources?topic=resources-tag)。
1. 为此 VPC 中的新子网选择或创建缺省 ACL。在本教程中，将创建新的缺省 ACL。后面将为该 ACL 配置规则。
1. 选择缺省安全组是否允许入站 SSH 和 ping 流量流至此 VPC 中的虚拟服务器实例。后面将为缺省安全组配置更多规则。
1. 为 VPC 中的新子网输入名称，例如 `my-subnet`。
1. 为子网选择位置。位置由区域和专区组成。

    选择的区域将用作 VPC 的区域。在此 VPC 中创建的所有其他资源都将在所选区域中创建。
    {: tip}

1. 以 CIDR 表示法输入子网的 IP 范围，例如：`10.240.0.0/24`。在大多数情况下，可以使用缺省 IP 范围。如果要指定定制 IP 范围，那么可以使用 IP 范围计算器来选择其他地址前缀或更改地址数。
1. 为子网选择 ACL。选择**使用 VPC 缺省值**可使用为此 VPC 创建的缺省 ACL。
1. 将公共网关连接到子网，以允许所有连接的资源与公用因特网进行通信。  

    您还可以在创建子网后连接公共网关。
    {: tip}

1. 单击**创建虚拟私有云**。
1. 要在此 VPC 中创建其他子网，请单击**子网**选项卡，然后单击**新建子网**。定义子网时，请确保在**虚拟私有云**字段中，选择 `my_vpc`。

## 配置 ACL

可以配置 ACL 以将入站和出站流量限制为流至子网。缺省情况下，将允许所有流量。

每个子网只能连接到一个 ACL。但是，每个 ACL 可以连接到多个子网。

要配置 ACL，请执行以下操作：

1. 在导航窗格中，单击**网络 > 子网**。
1. 单击已创建的子网。
1. 在**子网详细信息**区域中，单击 ACL 的名称。
1. 单击**添加规则**以配置入站和出站规则，这些规则定义允许进出子网的流量。对于每个规则，请指定以下信息：  
   * 指定规则的优先级。编号较小的规则将首先求值，并覆盖编号较大的规则。例如，如果优先级为 2 的规则允许 HTTP 流量，而优先级为 5 的规则拒绝所有流量，那么仍会允许 HTTP 流量。  
   * 选择是允许还是拒绝指定的流量。  
   * 指定 CIDR 块以指示将应用规则的 IP 范围。
   * 选择将应用规则的协议和端口。
1. 创建规则完成后，单击页面顶部的**所有访问控制表**面包屑。

### 示例 ACL

例如，可以配置执行以下操作的入站规则：

 1. 允许来自因特网的 HTTP 流量
 1. 允许来自子网 10.10.20.0/24 的所有入站流量
 1. 拒绝其他所有入站流量  

然后，配置执行以下操作的出站规则：

1. 允许 HTTP 流量流至因特网
1. 允许所有出站流量流至子网 10.10.20.0/24
1. 拒绝其他所有出站流量  

![显示样本入站和出站规则](images/acl-rules.png)

## 创建虚拟服务器实例

要在新创建的子网中创建虚拟服务器实例，请执行以下操作：

1. 单击导航窗格中的**计算 > 虚拟服务器实例**，然后单击**新建实例**。
1. 为实例输入名称，例如 `my-instance`。
1. 选择已创建的 VPC。
1. 在**位置**字段中，选择要在其中创建实例的专区。
1. 选择映像（即，操作系统和版本），例如 Ubuntu Linux 16.04。
1. 要设置实例大小，请选择其中一个常用概要文件，或者单击**所有概要文件**以选择最适合工作负载的其他核心和 RAM 组合。
1. 选择现有 SSH 密钥或添加新 SSH 密钥，此密钥将用于访问虚拟服务器实例。要添加 SSH 密钥，请单击**新建密钥**，然后对密钥命名。输入先前生成的公用密钥值后，单击**添加 SSH 密钥**。

只能在创建 VSI 的过程中初始添加密钥。以后没有任何工具可用于添加密钥。
{:tip}

1. _可选：_输入用户数据，以在实例启动时运行常见配置任务。例如，可为 Linux 映像指定 cloud-init 伪指令或 shell 脚本。有关更多信息，请参阅[用户数据](/docs/vpc-on-classic-vsi?topic=vpc-on-classic-vsi-user-data)。
1. 记下引导卷。在当前发行版中，将为引导卷分配 100 GB。为卷启用了*自动删除*；如果删除实例，那么将自动删除该卷。
1. 在**连接的块存储卷**区域中，可以单击**新建块存储卷**以将块存储卷连接到实例。在本教程中，我们将创建块存储卷，稍后将其连接到实例。
1. 在**网络接口**区域中，可以编辑网络接口，并更改其名称。如果所选专区和 VPC 中有多个子网，那么可以将其他子网连接到接口。如果希望实例存在于多个子网中，那么可以创建更多接口。

   您还可以选择要连接到每个接口的安全组。缺省情况下，会连接 VPC 的缺省安全组。缺省安全组允许入站 SSH 和 ping 流量、所有出站流量以及组中实例之间的所有流量。其他所有流量都会被阻塞；可以配置规则以允许更多流量。如果您稍后编辑了缺省安全组的规则，那么这些更新的规则将应用于组中的所有当前和未来实例。

1. 单击**创建虚拟服务器实例**。实例的状态一开始为*暂挂*，随后会更改为*已停止*，再更改为*已打开电源*。您可能需要刷新页面来查看状态的更改。

## 创建并连接块存储卷

可以创建块存储卷，并将其连接到虚拟服务器实例。

要创建并连接块存储卷，请执行以下操作：

1. 在导航窗格中，单击**存储 > 块存储卷**。
1. 在“VPC 的块存储卷”页面中，单击**新建卷**，然后指定以下信息。
  * **名称**：为块存储卷输入名称，例如 `data-volume-1`。  
  * **资源组**：为块存储卷选择资源组。资源组支持对帐户资源进行组织，以进行访问控制和计费。有关更多信息，请参阅[在资源组中组织资源的最佳实践](/docs/resources?topic=resources-bp_resourcegroups)。
  * **标记**：_可选：_输入标记以帮助您组织和查找资源。以后可以添加更多标记。有关更多信息，请参阅[使用标记](/docs/resources?topic=resources-tag)。
  * **位置**：为块存储卷选择位置。位置由区域和专区组成，例如美国南部 1。
  * **大小**：指定 10 GB 到 2000 GB 之间的卷大小。
  * **IOPS**：选择其中一个 IOPS 层，或者单击“定制”以根据卷大小输入 IOPS 值。
  * **加密**：接受缺省值“提供者管理的加密”，或者选择“客户管理的加密”，并使用您自己的加密密钥。此步骤需要供应 Key Protect 服务实例，并创建或导入根密钥。有关更多信息，请参阅[创建使用客户管理的加密的块存储卷](/docs/vpc-on-classic-block-storage?topic=vpc-on-classic-block-storage-block-storage-encryption#data-vol-encryption-ui)。
1. 单击**创建卷**。
1. 在块存储卷列表中，找到已创建的卷。当状态为“可用”时，请单击“...”，然后选择**连接到实例**。
1. 选择要将卷连接到的实例，然后单击**连接**。

## 为实例配置安全组

可以配置安全组，以定义针对实例允许的入站和出站流量。例如，在根据公司的安全策略为子网配置 ACL 规则后，可以根据特定实例的工作负载，进一步限制这些实例的流量。

要配置安全组，请执行以下操作：

1. 在“虚拟服务器实例”页面上，单击实例以查看其详细信息。
1. 在**网络接口**部分中，单击安全组。
1. 单击**添加规则**以配置入站和出站规则，这些规则定义允许进出实例的流量类型。对于每个规则，请指定以下信息：  
   * 指定用于所允许流量的 CIDR 块或 IP 地址。或者，可以在同一 VPC 中指定安全组，以允许连接到所选安全组的所有实例的进出流量。   
   * 选择将应用规则的协议和端口。    

   **提示：**  
  * 系统将对所有规则求值，而不考虑这些规则的添加顺序。
  * 规则是有状态的，这意味着会自动允许响应所允许流量的返回流量。例如，如果规则允许端口 80 上的入站 TCP 流量，那么还会允许在端口 80 上将出站 TCP 流量回复给发起主机，而无需额外的规则。
1. _可选：_如果要将此安全组连接到其他实例，请单击导航窗格中的**连接的接口**，然后选择其他接口。
1. 创建规则完成后，单击页面顶部的**所有安全组**面包屑。

### 示例安全组  

例如，可以配置执行以下操作的入站规则：

 * 允许所有 SSH 流量（TCP 端口 22）
 * 允许所有 ping 流量（ICMP 类型 8）

然后，配置允许所有 TCP 流量的出站规则。

![显示样本入站和出站规则](images/sg-example-ui.png)

## 保留浮动 IP 地址

保留并关联浮动 IP 地址，以支持实例可从因特网进行访问。  

实例必须正在运行，然后才能关联浮动 IP 地址。实例启动并运行可能需要几分钟时间。
{: tip}

要保留和关联浮动 IP 地址，请执行以下操作：

1. 在“虚拟服务器实例”页面上，单击实例以查看其详细信息。
1. 在**网络接口**部分中，对于要与浮动 IP 地址关联的接口，单击**保留**。

如果日后希望将此浮动 IP 地址重新分配给同一专区中的其他实例，请在**网络 > 浮动 IP** 页面上找到该浮动 IP 地址，单击其溢出菜单 (**...**)，然后单击**取消关联**。接着，单击**关联**，以选择要与该浮动 IP 地址关联的实例和网络接口。
{: tip}

## 连接到实例
使用已创建的浮动 IP 地址对实例执行 ping 操作，以确保它已启动并正在运行：

```
ping <public-ip-address>
```
{:pre}


### 连接到 Linux 映像

您已使用公用 SSH 密钥创建了实例，因此现在可以使用专用密钥来直接连接到该实例：


```
ssh -i <path-to-private-key-file> root@<public-ip-address>
```
{:pre}

请参阅[连接到使用 Linux 的实例](/docs/vpc-on-classic-vsi?topic=vpc-on-classic-vsi-connecting-to-your-linux-instance)，以获取有关如何连接到实例的更多信息。

### 连接到 Windows 映像
要连接到 Windows 映像，请使用其解密密码进行登录。要获取解密密码，请从实例的详细信息页面复制加密密码，然后运行以下命令：

```
# Decode the encrypted password
cat ~/examplepwd | base64 --decode > ~/examplepwd64
# Decrypt the decoded password using the RSA private key
openssl pkeyutl -in ~/examplepwd64 -decrypt -inkey private.pem -pkeyopt rsa_padding_mode:oaep -pkeyopt rsa_oaep_md:sha256
-pkeyopt rsa_mgf1_md:sha256
```
{:codeblock}


请参阅[连接到 Windows 实例](/docs/vpc-on-classic-vsi?topic=vpc-on-classic-vsi-connecting-to-your-windows-instance)，以获取有关如何连接到实例的更多信息。



## 监视实例

要获取显示实例何时启动、停止或重新引导的活动日志，请单击导航窗格中的**活动**。

## 创建负载均衡器
可以创建负载均衡器以在多个实例之间分配入站流量。

要创建负载均衡器，请执行以下操作：
1. 在导航窗格中，单击**网络 > 负载均衡器**。
1. 在“负载均衡器”页面中，单击**新建负载均衡器**，然后指定以下信息。
    * **名称**：为负载均衡器输入名称，例如 `my-load-balancer`。
    * **虚拟私有云**：选择您的 VPC。
    * **资源组**：为负载均衡器选择资源组。
    * **类型**：选择负载均衡器类型：公共或专用。
    * **区域**：指示将在其中创建负载均衡器的区域；即，为您的 VPC 选择的区域。
    * **子网**：选择要在其中创建负载均衡器的子网。要最大限度提高应用程序的可用性，请选择不同专区中的子网。
1. 单击**新建池**并指定以下信息以创建后端池。可以创建一个或多个池。
    * **名称**：为池输入名称，例如 `my-pool`。
    * **协议**：为负载均衡器后面的后端实例选择协议。池的协议必须与其关联侦听器的协议相匹配。例如，如果为侦听器选择了 HTTPS 或 HTTP 协议，那么池的协议必须为 HTTP。与此类似，如果侦听器协议是 TCP，那么后端池的协议也必须是 TCP。
    * **方法**：选择希望负载均衡器在后端实例之间分配流量的方式：
      * **循环法**：依次将请求转发给每个实例。所有实例收到的客户机连接数大致相等。
      * **加权循环法**：根据每个实例分配的权重，按比例将请求转发到每个实例。例如，如果您具有实例 A、B 和 C，其权重分别设置为 60、60 和 30，那么实例 A 和 B 收到的连接数相同，而实例 C 收到的连接数只有 A 和 B 的一半。
      * **最少连接数**：将请求转发到当前时间具有最少连接数的实例。  
    * **会话粘性**：选择是否用户会话期间的所有请求都发送到同一实例。  
    * **运行状况检查**：配置负载均衡器检查实例运行状况的方式。
      * **运行状况协议**：负载均衡器用于将运行状况检查消息发送到后端实例的协议。
      * **运行状况路径**：仅当选择 HTTP 作为运行状况检查协议时，运行状况路径才适用。运行状况路径指定负载均衡器用于将 HTTP 运行状况检查请求发送到后端实例的 URL。缺省情况下，运行状况检查会发送到根路径 (`/`)。
      * **时间间隔**：两次连续运行状况检查尝试之间的时间间隔（以秒为单位）。缺省情况下，每 5 秒发送一次运行状况检查。
      * **超时**：系统等待来自运行状况检查请求的响应的最大时间量。缺省情况下，负载均衡器等待获取响应的时间为 2 秒。
      * **最大重试次数**：负载均衡器在声明后端实例运行状况欠佳之前另外进行的运行状况检查尝试的最大次数。缺省情况下，两次运行状况检查失败后，即不会再认为实例运行状况正常。

        虽然负载均衡器会停止将连接发送到运行状况欠佳的实例，但负载均衡器仍会继续监视这些实例的运行状况，如果发现这些实例的运行状况恢复正常（即成功通过两次连续运行状况检查尝试），那么负载均衡器会恢复使用相应实例。

      如果后端实例运行状况欠佳，而您认为应用程序运行正常，请仔细检查运行状况协议和运行状况路径值。此外，请检查连接到实例的任何安全组，以确保规则允许负载均衡器与实例之间的流量。
      {: tip}

1. 单击**创建**。
1. 在新池的条目旁边，单击**实例**列中的**连接**以将实例添加到该池。单击**添加**可将更多实例添加到该池。为每个实例指定以下信息：
   * 选择要从中选择实例的一个或多个子网。
   * 选择实例。如果实例具有多个接口，请确保选择正确的 IP 地址。
   * 指定用于向实例发送流量的端口。
   * 如果池使用**加权循环法**，请为每个实例分配权重。  

      为实例分配权重“0”表示不会向该实例转发任何新连接，但只要当前连接处于活动状态，任何现有流量就会继续流动。使用权重“0”可帮助正常关闭实例，并将其从服务循环中除去。
      {: tip}

1. 单击**新建侦听器**并指定以下信息以创建侦听器。可以创建一个或多个侦听器。
   * **协议**：用于接收入局请求的协议。
   * **端口**：接收请求的侦听端口。端口范围 56500 到 56520 保留用于管理目的，不能使用。
   * **后端池**：此侦听器将流量转发到的后端池。
   * **最大连接数**（可选）：侦听器允许的最大并发连接数。
   * **SSL 证书**：如果为此侦听器选择的协议是 HTTPS，那么必须选择 SSL 证书。确保负载均衡器有权访问 SSL 证书。有关指示信息，请参阅[开始之前](#before)。
1. 单击**创建**。
1. 创建池和侦听器完成后，单击**创建负载均衡器**。
1. 要查看现有负载均衡器的详细信息，请单击**负载均衡器**页面上负载均衡器的名称。

## 创建 VPN
可以创建虚拟专用网 (VPN)，以便 VPC 可以安全地连接到其他专用网络，例如内部部署网络或其他 VPC。

要查看代码示例，请参阅[将 VPN 用于 VPC](/docs/vpc-on-classic-network?topic=vpc-on-classic-network---using-vpn-with-your-vpc)。
{: tip}

要创建 VPN，请执行以下操作：
1. 在导航窗格中，单击**网络 > VPN**。
1. 在 VPN 页面上，单击**新建 VPN 网关**，并指定以下信息：
    * **名称**：为虚拟私有云中的 VPN 网关输入名称，例如 `my-vpn-gateway`。
    * **虚拟私有云**：选择您的 VPC。
    * **资源组**：为 VPN 选择资源组。
    * **子网**：选择要在其中创建 VPN 网关的子网。
1. 在**新建 VPN 连接**部分中，通过指定以下信息来定义此网关与 VPC 外部网络之间的连接。
    * **连接名称**：为连接输入名称，例如 `my-connection`。
    * **同级网关地址**：指定 VPN 网关用于 VPC 外部网络的 IP 地址。
    * **预共享密钥**：指定 VPN 网关用于 VPC 外部网络的认证密钥。
    * **本地子网**：指定 VPC 中要通过 VPN 隧道连接的一个或多个子网。
    * **同级子网**：指定其他网络中要通过 VPN 隧道连接的一个或多个子网。
1. 要配置云网关如何发送消息来检查同级网关是否处于活动状态，请在**失效同级检测**部分中指定以下信息。
    * **失效同级检测操作**：同级网关停止响应时要执行的操作。例如，如果希望网关立即重新协商连接，请选择**重新启动**。
    * **时间间隔**：检查同级网关是否处于活动状态的频率。缺省情况下，每 30 秒发送一次消息。
    * **超时**：等待来自同级网关的响应的时间。缺省情况下，如果在 150 秒内未收到响应，那么将不再认为同级网关处于活动状态。
1. 指定用于连接的 IKE 和 IPsec 安全性参数。
    * 如果希望云网关尝试自动建立连接，请选择**自动**。
    * 如果需要强制实施特定安全需求，或者其他网络的 VPN 网关不支持通过自动协商进行尝试的安全建议，请选择或创建定制策略。

  **重要信息**：为连接指定的 IKE 和 IPsec 安全参数必须与用于 VPC 外部网络的网关上设置的参数相同。

## 祝贺您！

您已成功创建并配置了 VPC 和子网、ACL、虚拟服务器实例、块存储卷、安全组、浮动 IP 地址、负载均衡器以及 VPN。现在，可以通过添加更多实例、子网和其他资源来继续开发 VPC。
